{% extends "base.html" %}{% load markymark %}{% load leaflet_tags %}

{% block extrahead %}
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.16.0/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.16.0/mapbox-gl.css' rel='stylesheet' />
<style>
    #map {  /* all maps */
        width:  100%;
        height: 600px;
    }
</style>
{% endblock %}

{% block pagetitle %}
Map | {{ block.super }}
{% endblock %}

{% block content %}
<article class="project">

    <section class="map-container">
        <div id="map"></div>
    </section>

    <script type="text/javascript">
        var layer;
        mapboxgl.accessToken = '{{mapbox_token|safe}}';
        var map = new mapboxgl.Map({
            container: 'map', // container id
            style: '{{mapbox_style|default:"mapbox://styles/mapbox/streets-v8"}}',
            center: {{default_center|default:"[-274.4953579099464, 22.440381130024562]"}}, // starting position
            zoom: 3 // starting zoom
        });
        map.addControl(new mapboxgl.Navigation({position: 'top-left'}));

        map.on('style.load', function () {
            var geometries = {
                lines: '{% url "api:linestringgeometry-list" %}',
                points: '{% url "api:pointgeometry-list" %}',
                polygons: '{% url "api:polygongeometry-list" %}'
            }
            var paintStyles = {
                lines: {
                    'line-width': 6,
                    'line-color': '#FF0000'
                },
                points: {
                    'circle-color': '#00FF00',
                    'circle-radius': 6
                },
                polygons: {
                    'fill-color': '#0000FF'
                }
            }
            for (var prop in geometries) {
                if (geometries.hasOwnProperty(prop)) {
                    var src_name = prop + '-src';
                    var layer_id = prop + '-layer';
                    var drawType, refLayer;
                    switch (prop) {
                        case 'lines':
                            drawType = 'line';
                            refLayer = 'road-motorway';
                            break;
                        case 'points':
                            drawType = 'circle';
                            break;
                        case 'polygons':
                            drawType = 'fill';
                            break;
                        default:
                            drawType = null;
                            refLayer = null;
                    }
                    if (drawType) {
                        map.addSource(src_name, {
                            'type': 'geojson',
                            'data': geometries[prop]
                        });

                        var layerConfig = {
                            "id": layer_id,
                            "type": drawType,
                            "source": src_name,
                        };
                        if (paintStyles.hasOwnProperty(prop)) {
                            layerConfig['paint'] = paintStyles[prop];
                        }
                        map.addLayer(layerConfig);
                    }
                }
            }
        });
    </script>
</article>
{% endblock %}
