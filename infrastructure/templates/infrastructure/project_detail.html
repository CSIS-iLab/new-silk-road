{% extends "base.html" %}{% load markymark %}{% load leaflet_tags %}

{% block extrahead %}
{% spaceless %}
{% leaflet_js %}{% leaflet_css %}
{% endspaceless %}
{% endblock %}

{% block pagetitle %}
{{ object.name }} | {{ block.super }}
{% endblock %}

{% block content %}
<article class="project">
    <h2>{{ object.name }}</h2>
    {% if object.initiative %}
    <h3>Initiative: <a href="{{ object.initiative.get_absolute_url }}">{{ object.initiative.name }}</a></h3>
    {% endif %}
    <p>{{ object.get_countries_display }}</p>

    <section class="map-container">
{% leaflet_map "project_map" %}
    </section>

    <section class="notes">
{{ object.notes|markdown }}
    </section>


    <section class="documents">
        <h3>Documents</h3>
        <ul>{% for doc in object.documents.all  %}
            <li>
                <a rel="external" target="_blank" href="{{ doc.source_url }}">Document source</a>
            </li>
            {% endfor %}
        </ul>
    </section>
    <script type="text/javascript">
        var layer;
        window.addEventListener("map:init", function (e) {
            var detail = e.detail;

            var project_geo = {{object.geodata.geometry.geojson|safe|default:"null"}};
            var geo_attributes = {{object.geodata.attributes|safe|default:"null"}};

            if (project_geo) {
                layer = L.geoJson(project_geo, {
                    onEachFeature: function (feature, layer) {
                        if (feature.properties) {
                            layer.bindPopup(feature.properties.description);
                        }
                    }
                });

                detail.map.addLayer(layer);
                detail.map.fitBounds(layer.getBounds());
            }

        }, false);
    </script>
</article>
{% endblock %}
