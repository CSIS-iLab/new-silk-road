{% extends "base.html" %}{% load markymark %}{% load staticfiles %}

{% block extrahead %}
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.16.0/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.16.0/mapbox-gl.css' rel='stylesheet' />
<style>
    #map {
        width:  100%;
        height: 400px;
        display: block;
    }
    .mapboxgl-popup {
            max-width: 400px;
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
    }
    .marker-title {
        font-weight: 700;
    }
</style>
<script src='{% static "js/map-utils.js" %}'></script>
{% endblock %}

{% block pagetitle %}
{{ object.name }} | {{ block.super }}
{% endblock %}

{% block content %}
<article class="project">
    <h2>{{ object.name }}</h2>{% if object.initiative %}
    <h3>Initiative: <a href="{{ object.initiative.get_absolute_url }}">{{ object.initiative.name }}</a></h3>
{% endif %}
    <p>{{ object.get_countries_display }}</p>

{% if object.geo %}
    <section class="map-container">
        <div id="map"></div>
    </section>
{% endif %}

    <section class="notes">
{{ object.notes|markdown }}
    </section>


    <section class="documents">
        <h3>Documents</h3>
        <ul>{% for doc in object.documents.all  %}
            <li>
                <a rel="external" target="_blank" href="{{ doc.source_url }}">Document source</a>
            </li>
            {% endfor %}
        </ul>
    </section>
    {% if object.geo %}
    <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function () {
        var httpRequest, geostore;
        var linePaint = {
            'line-color': '#FF0000',
            'line-width': 3,
            'line-opacity': 0.6
        };
        var lineLayout = { 'line-cap': 'round' };

        function mapProject(data, camera) {
            if (data.lines && data.lines.features.length > 0) {
                map.addSource('lines-src', MapUtils.sourceForGeoJSON(data.lines));
                map.addLayer(MapUtils.layerFromSource('lines-layer', 'lines-src', 'line', linePaint, lineLayout));
            }
            if (data.points && data.points.features.length > 0) {
                map.addSource('points-src', MapUtils.sourceForGeoJSON(data.points));
                map.addLayer(MapUtils.layerFromSource('points-layer', 'points-src', 'circle'));
            }
            if (data.polygons && data.polygons.features.length > 0) {
                map.addSource('polygons-src', MapUtils.sourceForGeoJSON(data.polygons));
                map.addLayer(MapUtils.layerFromSource('polygons-layer', 'polygons-src', 'fill'));
            }
            map.fitBounds(camera.bounds, camera);
        }

        var geostore_url = "{% url 'api:geometrystore-detail' identifier=object.geo.identifier format='json' %}";


        mapboxgl.accessToken = '{{mapbox_token|safe}}';
        var map = new mapboxgl.Map({
            container: "map",
            style: '{{mapbox_style|default:"mapbox://styles/mapbox/streets-v8"}}',
            center: {{default_center|default:"[94.49535790994639, 22.440381130024562]"}}
        });
        map.addControl(new mapboxgl.Navigation({position: 'top-left'}));

        map.on('style.load', function () {
            var camera = {
                bounds: [{% for val in object.geo.calculate_overall_extent %}{% spaceless %}
                    {{val}}{% if not forloop.last%},{% endif %}{% endspaceless %}{% endfor %}],
                maxZoom: 15,
                padding: 10
            }

            if (geostore_url) {
                httpRequest = new XMLHttpRequest();
                httpRequest.addEventListener("readystatechange", function () {
                    if (httpRequest.readyState === XMLHttpRequest.DONE) {
                        geostore = JSON.parse(httpRequest.responseText);
                        mapProject(geostore, camera);
                    }
                })

                httpRequest.open('GET', geostore_url, true);
                httpRequest.send();
            }

        });
    });
    </script>
    {% endif %}
</article>
{% endblock %}
