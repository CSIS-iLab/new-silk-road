{% extends "base.html" %}{% load markymark %}{% load staticfiles %}

{% block extrahead %}
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.16.0/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.16.0/mapbox-gl.css' rel='stylesheet' />
<style>
    #map {
        width:  100%;
        height: 400px;
        display: block;
    }
    .mapboxgl-popup {
            max-width: 400px;
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
    }
    .marker-title {
        font-weight: 700;
    }
</style>
<script src='{% static "js/project.js" %}'></script>
{% endblock %}

{% block pagetitle %}
{{ object.name }} | {{ block.super }}
{% endblock %}

{% block content %}
<article class="project">
    <h2>{{ object.name }}</h2>{% if object.initiative %}
    <h3>Initiative: <a href="{{ object.initiative.get_absolute_url }}">{{ object.initiative.name }}</a></h3>
{% endif %}
    <p>{{ object.get_countries_display }}</p>

    <section class="map-container">
        <div id="map"></div>
    </section>

    <section class="notes">
{{ object.notes|markdown }}
    </section>


    <section class="documents">
        <h3>Documents</h3>
        <ul>{% for doc in object.documents.all  %}
            <li>
                <a rel="external" target="_blank" href="{{ doc.source_url }}">Document source</a>
            </li>
            {% endfor %}
        </ul>
    </section>
    {% if object.geo %}
    <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function () {
        var httpRequest, geostore;
        var mapbox_style = '{{mapbox_style|default:"mapbox://styles/mapbox/streets-v8"}}';
        mapboxgl.accessToken = '{{mapbox_token|safe}}';

        function mapProject(data, mapHelper, bounding) {
            var geoLayers = [];
            if (data.lines) {
                geoLayers.push({
                    src: { type: 'geojson', data: data.lines },
                    layer: {
                        id: 'project-lines', type: 'line',
                        source: 'project-lines-src'
                    }
                })
            }
            if (data.points) {
                geoLayers.push({
                    src: { type: 'geojson', data: data.points },
                    layer: {
                        id: 'project-points', type: 'circle',
                        source: 'project-points-src'
                    }
                })
            }
            if (data.polygons) {
                geoLayers.push({
                    src: { type: 'geojson', data: data.polygons },
                    layer: {
                        id: 'project-polygons', type: 'fill',
                        source: 'project-polygons-src'
                    }
                })
            }
            mapHelper.addLayers(geoLayers, bounding);

            if (data.points) mapHelper.setPopupLayers(['project-points']);
        }


        var bbox = [{% for val in object.geo.calculate_overall_extent %}{% spaceless %}
            {{val}}{% if not forloop.last%},{% endif %}{% endspaceless %}{% endfor %}];

        var geostore_url = "{% url 'api:geometrystore-detail' identifier=object.geo.identifier format='json' %}";


        var proj = new ProjectMap(mapboxgl, {
            container: "map",
            style: mapbox_style,
            center: {{default_center|default:"[94.49535790994639, 22.440381130024562]"}}
        });

        proj.map.on('style.load', function () {
            var bounding = {
                bbox: bbox,
                maxZoom: 15,
                padding: 10
            }

            if (geostore_url) {
                httpRequest = new XMLHttpRequest();
                httpRequest.addEventListener("readystatechange", function () {
                    if (httpRequest.readyState === XMLHttpRequest.DONE) {
                        geostore = JSON.parse(httpRequest.responseText);
                        mapProject(geostore, proj, bounding);
                    }
                })

                httpRequest.open('GET', geostore_url, true);
                httpRequest.send();
            }

            // var tooltip = new mapboxgl.Popup({closeOnClick: false})
            //     .setLngLat([100.544445, 20.872203])
            //     .setHTML('<h1>Hello World!</h1>')
            //     .addTo(proj.map);
        });
    });
    </script>
    {% endif %}
</article>
{% endblock %}
